<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>Örebro – Väder + Dagens text</title>
  <style>
  :root{
    --bg:#0f1115; --fg:#e8eaed; --muted:#a7b0bc; --card:#151922; --accent:#5aa7ff;
  }

  *{ box-sizing:border-box; }

  html,body{ height:100%; }
  body{
    margin:0;
    background:var(--bg);
    color:var(--fg);
    font:600 20px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial;
    overflow:hidden;
  }

  /* Use safe viewport height (Safari can misreport vh) */
  .grid{
    height:100svh;
    width:100vw;
    display:grid;
    grid-template-columns:1.1fr 1.6fr;
    gap:16px;
    padding:16px;
  }

  .card{
    height:100%;           /* critical: keep cards within grid height */
    min-height:0;          /* allow inner flex children to shrink */
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.06);
    border-radius:22px;
    padding:18px;          /* reduced from 26 */
    box-shadow:0 12px 34px rgba(0,0,0,.38);
    min-width:0;
  }

  /* WEATHER */
  .weather{
    display:flex;
    flex-direction:column;
    height:100%;
    min-height:0;
    gap:14px;              /* reduced */
  }
  .top{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .city{
    font-size:28px;
    font-weight:800;
    letter-spacing:-0.3px;
  }
  .badge{
    padding:6px 10px;
    border-radius:999px;
    background:#1b2230;
    color:var(--muted);
    font-size:13px;
    font-weight:700;
    white-space:nowrap;
  }
  .main{
    display:flex;
    align-items:center;
    gap:14px;
    flex-wrap:wrap;
  }
  .temp{
    font-size:78px;        /* reduced from 92 */
    font-weight:850;
    letter-spacing:-2px;
    line-height:1;
  }
  .summary{
    font-size:18px;
    font-weight:700;
  }
  .muted{ color:var(--muted); }

  .stats{
    margin-top:2px;
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:10px;
  }
  .stat{
    background:var(--card);
    border-radius:14px;
    padding:10px;          /* reduced from 14 */
    text-align:center;
    border:1px solid rgba(255,255,255,.06);
    font-size:14px;
  }
  .stat strong{
    display:block;
    margin-top:6px;
    font-size:18px;
    letter-spacing:-0.3px;
  }

  .footer{
    margin-top:auto;
    font-size:12px;        /* reduced */
    color:var(--muted);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  a{ color:var(--accent); text-decoration:none; }

  /* DAILY TEXT */
  .dt{
    display:flex;
    flex-direction:column;
    height:100%;
    min-height:0;
    gap:8px;
  }

  .dt-box{
    flex:1;
    min-height:0;
    background:var(--card);
    border-radius:14px;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    padding:14px;
    margin:5px;
    overflow:auto;
    -webkit-overflow-scrolling:touch;
    font-size:18px;        /* slightly smaller */
    line-height:1.45;
    font-weight:400;       /* make daily text regular */
  }

  .dt-box p{ margin:0 0 0.8em; }

  /* If your EPUB uses <em> as headings and you want them bold */
  .dt-box em { font-weight:700; }
  </style>
</head>

<body>
  <div class="grid">
    <!-- WEATHER -->
    <section class="card weather">
      <div class="top">
        <div class="city">Örebro</div>
        <div class="badge" id="time">—</div>
      </div>

      <div class="main">
        <div class="temp" id="temp">–°</div>
        <div>
          <div class="summary" id="summary">Hämtar från SMHI…</div>
          <div class="muted" id="valid">—</div>
        </div>
      </div>

      <div class="stats">
        <div class="stat">Känns som<br><strong id="feels">–°</strong></div>
        <div class="stat">Vind<br><strong id="wind">– m/s</strong></div>
        <div class="stat">Nederbörd<br><strong id="precip">– mm/h</strong></div>
      </div>

      <div class="footer">
        <span>SMHI prognos (PMP3G)</span>
        <a href="https://opendata.smhi.se/metfcst/" target="_blank" rel="noreferrer">Källa</a>
      </div>
    </section>

    <!-- DAILY TEXT -->
    <section class="card dt">
      <div id="dtContent" class="dt-box" aria-live="polite"></div>
    </section>
  </div>

<script>
/* ========= CONFIG ========= */
const LAT = 59.2741, LON = 15.2066;        // Örebro (approx)
const WEATHER_REFRESH_MS = 5 * 60 * 1000;

const OPF_PATH  = 'es25_Z/OEBPS/content.opf';
const OEBPS_DIR = 'es25_Z/OEBPS/';
const START_ID  = 'chapter5';              // your plan start

// Daily schedule
const DAILY_TEXT_HOUR = 0,  DAILY_TEXT_MIN = 10; // refresh 00:10
const RELOAD_HOUR     = 3,  RELOAD_MIN     = 0;  // hard reload 03:00
/* ========================= */

// SMHI Wsymb2 (1–27) -> SV
const W = {
  1:"Klart", 2:"Nästan klart", 3:"Växlande molnighet", 4:"Halvklart", 5:"Molnigt", 6:"Mulet", 7:"Dimma",
  8:"Lätta regnskurar", 9:"Måttliga regnskurar", 10:"Kraftiga regnskurar", 11:"Åskskurar",
  12:"Lätta skurar av snöblandat regn", 13:"Måttliga skurar av snöblandat regn", 14:"Kraftiga skurar av snöblandat regn",
  15:"Lätta snöbyar", 16:"Måttliga snöbyar", 17:"Kraftiga snöbyar",
  18:"Lätt regn", 19:"Regn", 20:"Kraftigt regn", 21:"Åska",
  22:"Lätt snöblandat regn", 23:"Snöblandat regn", 24:"Kraftigt snöblandat regn",
  25:"Lätt snöfall", 26:"Snöfall", 27:"Kraftigt snöfall"
};

const el = id => document.getElementById(id);

function fmtClock(){
  return new Date().toLocaleString("sv-SE", { weekday:"long", hour:"2-digit", minute:"2-digit" });
}

function pickParam(params, name){
  const p = params.find(p => p.name === name);
  return p && p.values ? p.values[0] : null;
}

/* ---------- WEATHER (SMHI) ---------- */
async function loadSmhi(){
  const url = `https://opendata-download-metfcst.smhi.se/api/category/pmp3g/version/2/geotype/point/lon/${LON}/lat/${LAT}/data.json`;
  const r = await fetch(url, { cache: "no-store" });
  if(!r.ok) throw new Error("SMHI HTTP " + r.status);

  const j = await r.json();
  const now = new Date();
  const ts = j.timeSeries.find(t => new Date(t.validTime) >= now) || j.timeSeries[0];

  const t    = pickParam(ts.parameters, "t");        // °C
  const ws   = pickParam(ts.parameters, "ws");       // m/s
  const pmean= pickParam(ts.parameters, "pmean");    // mm/h
  const sym  = pickParam(ts.parameters, "Wsymb2");   // 1..27

  el("temp").textContent = Math.round(t) + "°";
  el("feels").textContent = Math.round(t) + "°";     // SMHI lacks apparent temp here
  el("wind").textContent = (Math.round(ws*10)/10) + " m/s";
  el("precip").textContent = (pmean ?? 0) + " mm/h";
  el("summary").textContent = W[sym] || "—";

  const vt = new Date(ts.validTime).toLocaleString("sv-SE", { hour:"2-digit", minute:"2-digit" });
  el("valid").textContent = `Gäller kl ${vt}`;
}

/* ---------- DAILY TEXT (EPUB) ---------- */
function dayOfYearLocal(){
  const now = new Date();
  const start = new Date(now.getFullYear(), 0, 0);
  return Math.floor((now - start) / 86400000);
}

function stripExtras(doc){
  doc.querySelectorAll('div.groupExt').forEach(n => n.remove());
  doc.querySelectorAll('figcaption').forEach(n => n.remove());
  return doc;
}

async function loadDailyText(){
  const out = el("dtContent");

  try{
    const resp = await fetch(OPF_PATH, { cache: "no-store" });
    if(!resp.ok) throw new Error("OPF saknas: " + resp.status);
    const xmlText = await resp.text();

    const xml = new DOMParser().parseFromString(xmlText, "application/xml");
    if (xml.querySelector("parsererror")) throw new Error("XML parserfel i OPF.");

    const items = Array.from(xml.querySelectorAll('item[id^="chapter"]'))
      .map(n => ({
        id: n.getAttribute("id"),
        n: parseInt(n.getAttribute("id").replace("chapter",""), 10),
        href: n.getAttribute("href")
      }))
      .filter(x => Number.isFinite(x.n))
      .sort((a,b) => a.n - b.n);

    if(!items.length) throw new Error("Inga chapter-items hittades i OPF.");

    const startIndex = Math.max(0, items.findIndex(x => x.id === START_ID));
    const doy = dayOfYearLocal();
    const idx = (startIndex + (doy - 1)) % items.length;
    const chosen = items[idx];

    const chapterUrl = OEBPS_DIR + chosen.href;
    const ch = await fetch(chapterUrl, { cache: "no-store" });
    if(!ch.ok) throw new Error("Kunde inte läsa kapitel: " + ch.status);
    const chapterHtml = await ch.text();

    const doc = new DOMParser().parseFromString(chapterHtml, "text/html");
    stripExtras(doc);

    const container =
      doc.querySelector("main") ||
      doc.querySelector("article") ||
      doc.querySelector("section") ||
      doc.body;

    out.innerHTML = container ? container.innerHTML : doc.body.innerHTML;
  }catch(e){
    console.error(e);
    // If you still want a silent failure: just clear content
    el("dtContent").textContent = "";
  }
}

/* ---------- SCHEDULING ---------- */
function msUntilNextLocal(hour, minute=0){
  const now = new Date();
  const next = new Date();
  next.setHours(hour, minute, 0, 0);
  if (next <= now) next.setDate(next.getDate() + 1);
  return Math.max(next - now, 30 * 1000);
}

let dailyTextTimer = null;
let reloadTimer = null;

function scheduleDailyText(){
  if (dailyTextTimer) clearTimeout(dailyTextTimer);
  dailyTextTimer = setTimeout(() => {
    loadDailyText();
    scheduleDailyText();
  }, msUntilNextLocal(DAILY_TEXT_HOUR, DAILY_TEXT_MIN));
}

function scheduleNightlyReload(){
  if (reloadTimer) clearTimeout(reloadTimer);
  reloadTimer = setTimeout(() => location.reload(), msUntilNextLocal(RELOAD_HOUR, RELOAD_MIN));
}

/* ---------- START ---------- */
function tickClock(){ el("time").textContent = fmtClock(); }
tickClock();
setInterval(tickClock, 30 * 1000);

(async () => {
  // Initial loads
  try { await loadSmhi(); } catch(e){ console.error(e); el("summary").textContent = "Kunde inte hämta väder."; }
  loadDailyText();

  // Refresh loops
  setInterval(() => loadSmhi().catch(e => console.error(e)), WEATHER_REFRESH_MS);

  // Daily schedules
  scheduleDailyText();
  scheduleNightlyReload();
})();
</script>
</body>
</html>
